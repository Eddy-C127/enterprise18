<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="project_enterprise.project_task_action_planning_groupby_user" model="ir.actions.act_window">
        <field name="context" eval="{'search_default_group_by_user_id': 1, 'fsm_mode': True}"/>
    </record>

    <!-- allow billable and default product on new project form -->
    <record id="project_view_form_simplified_inherit" model="ir.ui.view">
        <field name="name">project.view.form.simplified.inherit</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="hr_timesheet.project_project_view_form_simplified_inherit_timesheet"/>
        <field name="arch" type="xml">
            <field name="allow_planning" position="after">
                <field name="allow_billable"/>
                <field name="timesheet_product_id" attrs="{'invisible': [('allow_billable', '=', False)]}"/>
            </field>
        </field>
    </record>


    <!-- Make quotations on tasks and tasks overlap warning in Project-->
    <record id="view_task_form2_inherit" model="ir.ui.view">
        <field name="name">view.task.form2.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position='inside'>
                <field name="allow_billable" invisible="True"/>
            </xpath>
            <xpath expr="//header" position="after">
                <div role="alert" class="alert-warning p-3 text-center"
                    attrs="{'invisible': ['|', ('allow_planning', '=', False), ('planning_overlap', '=', 0)]}">
                    <field name="planning_overlap"/> other task(s) for this employee at the same time.
                </div>
            </xpath>
            <xpath expr="//field[@name='user_id']" position="after">
                <xpath expr="//field[@name='partner_id']" position="move"/>
                <xpath expr="//field[@name='sale_line_id']" position="move"/>
            </xpath>
            <xpath expr="//field[@name='sale_line_id']" position="attributes">
                <attribute name="attrs">
                    {'invisible': ['|', ('allow_billable', '=', False), ('partner_id', '=', False)]}
                </attribute>
            </xpath>
            <xpath expr="//button[@name='toggle_active']" position="before">
                <button class="oe_stat_button" name="action_view_material"
                    type="object" icon="fa-cart-plus" help="Add materials" attrs="{'invisible': ['|', '|', ('allow_billable', '=', False), ('billable_type', '!=', 'no'), ('sale_order_id', '!=', False)]}">
                    <div class="o_stat_info">
                        <span class="o_stat_value">
                            <field name="material_line_product_count" widget="statinfo" string="Products" class="mr-1"/>
                        </span>
                        <field name="material_line_total_price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                        <field name="currency_id" invisible="True"/>
                    </div>
                </button>
            </xpath>
            <xpath expr="//field[@name='planned_date_begin']" position="before">
                <button class="btn btn-secondary pl-0 pr-0" type="action" name="%(project_enterprise.project_task_action_planning_groupby_user)d" context="{'default_project_id': project_id, 'search_default_user': 1}" attrs="{'invisible': ['|', ('allow_planning', '=', False), '&amp;', ('planned_date_begin', '!=', False), ('planned_date_end', '!=', False)]}">Plan this task</button>
            </xpath>
            <xpath expr="//page[@name='extra_info']" position="attributes">
                <attribute name="groups">base.group_no_one</attribute>
            </xpath>
        </field>
    </record>


    <record id="project_view_form_inherit" model="ir.ui.view">
        <field name="name">project.view.form.inherit</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.edit_project"/>
        <field name="arch" type="xml">
            <xpath expr="//group[@name='extra_settings']" position="inside">
                <field name="allow_billable"/>
                <field name="timesheet_product_id" attrs="{'invisible': [('allow_billable', '=', False)]}"/>
                <field name="product_template_ids" widget="many2many_tags" attrs="{'invisible': [('allow_billable', '=', False)]}"/>
            </xpath>
        </field>
    </record>

    <!-- fsm timesheet form view -->
    <record id="timesheet_view_form" model="ir.ui.view">
        <field name="name">account.analytic.line.form</field>
        <field name="model">account.analytic.line</field>
        <field name="priority">5000</field>
        <field name="arch" type="xml">
            <form string="Timesheet">
                <sheet>
                    <group>
                        <group>
                            <field name="project_id" required="1"/>
                            <field name="task_id" context="{'default_project_id': project_id}"/>
                            <field name="user_id" invisible="1" groups="hr_timesheet.group_timesheet_manager"/>
                            <field name="employee_id" groups="hr_timesheet.group_timesheet_manager"/>
                        </group>
                        <group>
                            <field name="date"/>
                            <field name="unit_amount" string="Time Spent" widget="timesheet_uom"/>
                            <field name="name" widget="text"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- fsm timesheet tree view -->
    <record id="timesheet_view_tree_user_inherit" model="ir.ui.view">
        <field name="name">account.analytic.line.view.tree.with.user.inherit.industry.fsm</field>
        <field name="model">account.analytic.line</field>
        <field name="inherit_id" ref="hr_timesheet.timesheet_view_tree_user"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='project_id']" position="attributes">
                <attribute name="invisible">context.get('default_project_id')</attribute>
            </xpath>
            <xpath expr="//field[@name='task_id']" position="attributes">
                <attribute name="invisible">context.get('default_task_id')</attribute>
            </xpath>
            <xpath expr="//field[@name='date']" position="attributes">
                <attribute name="invisible">context.get('from_field_service')</attribute>
            </xpath>
        </field>
    </record>

    <!-- fsm task form view -->
    <record id="project_task_view_form_fsm" model="ir.ui.view">
        <field name="name">project.task.view.form.fsm</field>
        <field name="model">project.task</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <field name="use_timesheet_timer" invisible="True"/>
                    <field name="allow_timesheets" invisible="True"/>
                    <field name="allow_billable" invisible="True"/>
                    <field name="timesheet_ids" invisible="True"/>
                    <field name="fsm_is_done" invisible="True"/>
                    <field name="analytic_account_active" invisible="True"/>
                    <field name="company_id" invisible="1"/>
                    <button class="btn-primary" name="action_timer_start" type="object" string="Start"
                        attrs="{'invisible': ['|', '|', '|', ('timesheet_timer_start', '!=', False), ('allow_timesheets', '=', False), ('use_timesheet_timer', '=', False), ('analytic_account_active', '=', False)]}" style="margin-left: 16px;"/>
                    <button class="btn-danger o_fsm_stop" name="action_timer_stop" type="object" string="Stop"
                        attrs="{'invisible': ['|', '|', '|', ('timesheet_timer_start', '=', False), ('allow_timesheets', '=', False), ('use_timesheet_timer', '=', False), ('analytic_account_active', '=', False)]}" style="margin-left: 16px;"/>
                    <button class="btn-primary" name="action_set_done" type="object" string="Validate"
                        attrs="{'invisible': [('fsm_is_done', '=', True)]}" style="margin-left: 16px;"/>
                    <field name="timesheet_timer_start" widget="timesheet_timer" class="text-danger pull-right h2 mr-4 mt-2 font-weight-bold"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" name="action_view_material"
                            type="object" icon="fa-cart-plus" help="Add materials" attrs="{'invisible': ['|', '|', ('fsm_is_done', '=', True), ('allow_billable', '=', False), ('sale_order_id', '!=', False)]}">
                            <div class="o_stat_info">
                                <span class="o_stat_value">
                                    <field name="material_line_product_count" widget="statinfo" string="Products" class="mr-1"/>
                                </span>
                                <field name="material_line_total_price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                <field name="currency_id" invisible="True"/>
                            </div>
                        </button>
                        <button class="oe_stat_button" name="action_view_timesheets"
                            type="object" icon="fa-clock-o" help="Time recorded on this task" attrs="{'invisible': [('timesheet_ids', '=', [])]}">
                            <div class="o_stat_info">
                                <div>Time</div>
                                <span class="o_stat_value">
                                    <field name="total_hours_spent" widget="float_time" nolabel="1" class="mr-1" />
                                </span>
                            </div>
                        </button>
                        <field name="sale_order_id" invisible="1"/>
                    </div>
                    <group>
                        <group>
                            <label for="name" class="oe_edit_only"/>
                            <field name="name" nolabel="1" class="oe_edit_only"/>
                            <field name="partner_id"
                                context="{'search_default_customer':1, 'show_address': 1, 'default_is_company': True, 'show_vat': True}"
                                options='{"always_reload": True, "no_quick_create": True}'
                                widget="res_partner_many2one"/>
                            <field name="partner_phone" widget="phone" attrs="{'invisible': [('partner_phone', '=', False)]}"/>
                            <field name="partner_mobile" widget="phone" attrs="{'invisible': [('partner_mobile', '=', False)]}"/>
                            <field name="partner_email" widget="email"  attrs="{'invisible': [('partner_email', '=', False)]}"/>
                        </group>
                        <group>
                            <label for="project_id" class="oe_edit_only"/>
                            <field name="project_id" domain="[('allow_planning', '=', True)]" context="{'default_allow_planning': True, 'default_allow_billable': True}" required="True" nolabel="1" class="oe_edit_only"/>
                            <label for="planned_date_begin" string="Date"/>
                            <div class="o_row">
                                <field name="planned_date_begin"/>
                                <span attrs="{'invisible': [('planned_date_end', '=', False)]}"> to </span>
                                <field name="planned_date_end"/>
                            </div>
                            <field name="user_id" options="{'no_open': True}"/>
                        </group>
                        <field name="description" colspan="2"/>
                    </group>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Quotation button in Project task form -->
    <record id="project_task_view_form_quotation" model="ir.ui.view">
        <field name="name">view.form.fsm.inherit.quotation</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="view_task_form2_inherit"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_view_material']" position="after">
                <button class="oe_stat_button mr-3" name="create_or_view_created_quotations"
                    type="object" help="Quotations created from this task" attrs="{'invisible': [('allow_billable', '=', False)]}">
                    <div class="ml-3" attrs="{'invisible': [('quotation_count', '!=', 0)]}">
                        <i class="fa fa-lg fa-plus-circle mr-2" aria-label="Create new quotation" title="Create new quotation"/>
                        New Quotation
                    </div>
                    <div class="ml-3" attrs="{'invisible': [('quotation_count', '=', 0)]}">
                        <i class="fa fa-lg fa-pencil-square-o mr-2" aria-label="View quotations" title="View quotations" role="img"/>
                        <field name="quotation_count" widget="statinfo" string="Quotation(s)" class="mr-1"/>
                    </div>
                </button>
            </xpath>
        </field>
        <field name="groups_id" eval="[(4, ref('sales_team.group_sale_salesman'))]"/>
    </record>

    <!-- Quotation and sales order button in Fsm task form -->
    <record id="project_task_view_form_fsm_quotation" model="ir.ui.view">
        <field name="name">view.form.fsm.inherit.quotation</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project_task_view_form_fsm"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_view_material']" position="after">
                <button class="oe_stat_button mr-3" name="create_or_view_created_quotations"
                    type="object" help="Quotations created from this task" attrs="{'invisible': [('allow_billable', '=', False)]}">
                    <div class="ml-3" attrs="{'invisible': [('quotation_count', '!=', 0)]}">
                        <i class="fa fa-lg fa-plus-circle mr-2" aria-label="Create new quotation" title="Create new quotation"/>
                        New Quotation
                    </div>
                    <div class="ml-3" attrs="{'invisible': [('quotation_count', '=', 0)]}">
                        <i class="fa fa-lg fa-pencil-square-o mr-2" aria-label="View quotations" title="View quotations" role="img"/>
                        <field name="quotation_count" widget="statinfo" string="Quotation(s)" class="mr-1"/>
                    </div>
                </button>
                <button type="object" name="action_view_so" class="oe_stat_button" icon="fa-dollar"
                    attrs="{'invisible': [('sale_order_id', '=', False)]}" string="Sales Order"/>
            </xpath>
        </field>
        <field name="groups_id" eval="[(4, ref('sales_team.group_sale_salesman'))]"/>
    </record>

    <!-- Improve the task kanban in Project -->
    <record id="view_task_kanban_inherit" model="ir.ui.view">
        <field name="name">view.task.kanban.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//div[hasclass('oe_kanban_bottom_left')]" position="inside">
                <field name="timesheet_timer_start" invisible="True" />
                <field name="planned_date_begin" invisible="True"/>
                <field name="planned_date_end" invisible="True"/>
                <t t-if="record.planned_date_begin.raw_value and record.planned_date_end.raw_value">
                    <div t-if="moment(record.planned_date_begin.raw_value.toISOString()).isAfter(moment().add(-1, 'days').endOf('day')) and moment().endOf('day').isAfter(moment(record.planned_date_begin.raw_value.toISOString()))"
                        role="status" class="alert-warning" t-esc="moment(record.planned_date_begin.raw_value.toISOString()).format('LT')"/>
                    <div t-else="" role="status" t-attf-class="#{moment().startOf('day').isAfter(moment(record.planned_date_begin.raw_value.toISOString())) ? 'alert-danger' : ''}"
                        t-esc="moment(record.planned_date_begin.raw_value.toISOString()).format('ll')"/>
                </t>
                <t t-if="record.timesheet_timer_start.raw_value">
                    <i class="fa fa-play" style="color: green; font-size: 20px;"></i>
                </t>
            </xpath>
        </field>
    </record>

    <record id="project_task_view_search" model="ir.ui.view">
        <field name="name">project.task.view.search</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <search string="Search planning">
                <filter string="My Tasks" name="my_tasks"
                    domain="[('user_id', '=', uid)]"/>
                <separator />
                <filter name="planned_today" string="Planned for Today" domain="[
                    ('planned_date_begin','&lt;=', datetime.datetime.combine(context_today(), datetime.time(23,59,59))),
                    ('planned_date_begin','&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0)))]"/>
                <filter name="planned_future" string="Future" domain="[('planned_date_begin', '>=', datetime.datetime.combine(context_today(), datetime.time(0,0,0)))]"/>
            </search>
        </field>
    </record>

    <!-- Kanban for the app -->
    <record id="project_task_view_kanban" model="ir.ui.view">
        <field name="name">project.task.view.kanban</field>
        <field name="model">project.task</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <kanban default_group_by="planned_date_begin:day" default_order="planned_date_begin" class="o_fsm_kanban">
                <field name="user_id"/>
                <field name="planned_date_begin"/>
                <field name="partner_id" widget="res_partner_many2one"/>
                <field name="activity_state"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content row">
                                <div class="col">
                                    <strong><field name="name" string="Task name"/></strong>
                                    <div>
                                        <field name="partner_id"/>
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_left">
                                            <strong><t t-if="record.planned_date_begin.raw_value" t-esc="moment(record.planned_date_begin.raw_value.toISOString()).format('HH:mm')"/></strong>
                                            <field name="activity_ids" widget="kanban_activity"/>
                                        </div>
                                        <div class="oe_kanban_bottom_right">
                                            <div class="badge badge-primary" t-if="widget.getParent().getParent().columnOptions and widget.getParent().getParent().columnOptions.groupedBy != 'stage_id'">
                                                <field name="stage_id"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Main action for the app -->
    <record id="project_task_action_worker_tasks" model="ir.actions.server">
        <field name="name">project.task.action.worker.tasks</field>
        <field name="model_id" ref="industry_fsm.model_project_task"/>
        <field name="state">code</field>
        <field name="code"> action = model.action_worker_tasks()</field>
    </record>

    <menuitem id="menu_fsm_root"
        name="Field Service"
        sequence="25"
        web_icon="industry_fsm,static/description/icon.png"
        groups="industry_fsm.group_fsm_user"/>

    <menuitem id="fsm_tasks_menu"
        name="My Tasks"
        action="project_task_action_worker_tasks"
        sequence="10"
        parent="industry_fsm.menu_fsm_root"
        groups="industry_fsm.group_fsm_user"/>

    <menuitem id="fsm_planning_menu"
        name="Planning"
        sequence="15"
        parent="industry_fsm.menu_fsm_root"
        groups="industry_fsm.group_fsm_manager"/>

    <menuitem id="project_task_menu_planning_by_user_fsm"
        name="By User"
        sequence="10"
        action="project_enterprise.project_task_action_planning_groupby_user"
        parent="fsm_planning_menu"/>

    <menuitem id="project_task_menu_planning_by_project_fsm"
        name="By Project"
        sequence="15"
        action="project_enterprise.project_task_action_planning_groupby_project"
        parent="fsm_planning_menu"/>

</odoo>
