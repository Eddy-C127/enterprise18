<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Make quotations on tasks and tasks overlap warning in Project-->
    <record id="view_task_form2_inherit" model="ir.ui.view">
        <field name="name">view.task.form2.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position='inside'>
                <field name="is_fsm" invisible="1"/>
            </xpath>
            <xpath expr="//header" position="after">
                <div role="alert" class="alert-warning p-3 text-center"
                    attrs="{'invisible': ['|', ('is_fsm', '=', False), ('planning_overlap', '=', 0)]}">
                    <button name="action_fsm_view_overlapping_tasks" type="object" class="btn-link pr-1">
                        <field name="planning_overlap"/> tasks
                    </button>
                    <span class="align-middle">for this employee at the same time.</span>
                </div>
            </xpath>
            <xpath expr="//field[@name='user_id']" position="after">
                <xpath expr="//field[@name='partner_id']" position="move"/>
                <xpath expr="//field[@name='sale_line_id']" position="move"/>
            </xpath>
            <xpath expr="//field[@name='sale_line_id']" position="attributes">
                <attribute name="attrs">
                    {'invisible': ['|', ('is_fsm', '=', False), ('partner_id', '=', False)]}
                </attribute>
            </xpath>
            <xpath expr="//page[@name='extra_info']" position="attributes">
                <attribute name="groups">base.group_no_one</attribute>
            </xpath>
        </field>
    </record>

    <record id="project_view_form_inherit" model="ir.ui.view">
        <field name="name">project.view.form.inherit</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.edit_project"/>
        <field name="priority" eval="36" />
        <field name="arch" type="xml">
            <xpath expr="//field[@name='privacy_visibility']" position="after">
                <field name="is_fsm" attrs="{'invisible': [('billable_type', '!=', 'no')]}"/>
            </xpath>
            <xpath expr="//group[@name='extra_settings']" position="after">
                <group name="fsm_options" attrs="{'invisible': [('is_fsm', '=', False)]}">
                    <field name="timesheet_product_id" attrs="{'invisible': [('is_fsm', '=', False)], 'required': [('is_fsm', '=', True)]}"/>
                </group>
            </xpath>
            <xpath expr="//group[@name='extra_settings']" position="attributes">
                <attribute name="attrs">{'invisible': [('is_fsm', '=', True)]}</attribute>
            </xpath>
        </field>
    </record>

    <record id="project_project_view_form" model="ir.ui.view">
        <field name="name">project.project.form.inherit</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="sale_timesheet.project_project_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_make_billable']" position="attributes">
                <attribute name="attrs">{'invisible': ['|', ('billable_type', '!=', 'no'), ('is_fsm', '=', True)]}</attribute>
            </xpath>
        </field>
    </record>

    <!-- fsm timesheet form view -->
    <record id="timesheet_view_form" model="ir.ui.view">
        <field name="name">account.analytic.line.form</field>
        <field name="model">account.analytic.line</field>
        <field name="priority">5000</field>
        <field name="arch" type="xml">
            <form string="Timesheet">
                <sheet>
                    <group>
                        <group>
                            <field name="project_id" required="1"/>
                            <field name="task_id" context="{'default_project_id': project_id}"/>
                            <field name="user_id" invisible="1" groups="hr_timesheet.group_timesheet_manager"/>
                            <field name="employee_id" groups="hr_timesheet.group_timesheet_manager"/>
                        </group>
                        <group>
                            <field name="date"/>
                            <field name="unit_amount" string="Time Spent" widget="timesheet_uom"/>
                            <field name="name" widget="text"/>
                            <field name="company_id" invisible="1"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- fsm timesheet tree view -->
    <record id="timesheet_view_tree_user_inherit" model="ir.ui.view">
        <field name="name">account.analytic.line.view.tree.with.user.inherit.industry.fsm</field>
        <field name="model">account.analytic.line</field>
        <field name="inherit_id" ref="hr_timesheet.timesheet_view_tree_user"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='project_id']" position="attributes">
                <attribute name="invisible">context.get('default_project_id')</attribute>
            </xpath>
            <xpath expr="//field[@name='task_id']" position="attributes">
                <attribute name="invisible">context.get('default_task_id')</attribute>
            </xpath>
            <xpath expr="//field[@name='date']" position="attributes">
                <attribute name="invisible">context.get('fsm_mode')</attribute>
            </xpath>
        </field>
    </record>

    <!-- Quotation button in Project task form -->
    <record id="project_task_view_form_quotation" model="ir.ui.view">
        <field name="name">view.form.fsm.inherit.quotation</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <field name="is_fsm" invisible="1"/>
                <button class="btn-secondary" name="action_fsm_create_quotation" type="object" string="New Quotation" attrs="{'invisible': ['|', ('is_fsm', '=', False), ('timesheet_timer_start', '!=', False)]}" groups="industry_fsm.group_fsm_quotation_from_task"/>
            </xpath>
            <div name="button_box" position="inside">
                <button name="action_fsm_view_quotations"
                    type="object"
                    class="oe_stat_button"
                    icon="fa-pencil-square-o"
                    attrs="{'invisible': ['|', ('is_fsm', '=', False), ('quotation_count', '=', 0)]}">
                    <field string="Quotation(s)" name="quotation_count" widget="statinfo"/>
                </button>
            </div>
        </field>
        <field name="groups_id" eval="[(4, ref('sales_team.group_sale_salesman'))]"/>
    </record>

    <!--
        FSM Task views
    -->

    <record id="project_task_view_form" model="ir.ui.view">
        <field name="name">project.task.form.fsm</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <form>
                <header attrs="{'invisible': [('id', '=', False)]}">
                    <field name="display_timesheet_timer" invisible="1"/>
                    <field name="is_fsm" invisible="1"/>
                    <field name="allow_timesheets" invisible="1"/>
                    <field name="fsm_state" invisible="1"/>
                    <field name="timesheet_timer_pause" invisible="1"/>
                    <field name="company_id" invisible="1"/>

                    <button class="btn-primary" name="action_fsm_validate" type="object" string="Mark as done"
                        attrs="{'invisible': ['|', '|', '|', ('timesheet_timer_start', '!=', False), ('fsm_state', '!=', 'draft'),  ('timesheet_ids', '=', []), ('material_line_product_count', '=', 0)]}"/>
                    <button class="btn-secondary" name="action_fsm_validate" type="object" string="Mark as done"
                        attrs="{'invisible': ['|', ('timesheet_ids', '=', []), '|', '|', ('timesheet_timer_start', '!=', False), ('fsm_state', '!=', 'draft'), '&amp;', ('timesheet_ids', '!=', []), ('material_line_product_count', '!=', 0)]}"/>

                    <button class="btn-primary" name="action_timer_start" type="object" string="Start"
                        attrs="{'invisible': ['|', '|', '|', ('timesheet_ids', '!=', []), ('fsm_state', '!=', 'draft'), ('timesheet_timer_start', '!=', False), ('display_timesheet_timer', '=', False)]}"/>
                    <button class="btn-secondary" name="action_timer_start" type="object" string="Start"
                        attrs="{'invisible': ['|', '|', '|', ('timesheet_ids', '=', []), ('fsm_state', '!=', 'draft'), ('timesheet_timer_start', '!=', False), ('display_timesheet_timer', '=', False)]}"/>
                    <button class="btn-primary btn-danger o_fsm_stop" name="action_timer_stop" type="object" string="Stop"
                        attrs="{'invisible': ['|', ('timesheet_timer_start', '=', False), ('display_timesheet_timer', '=', False)]}"/>
                    <button class="btn-primary" name="action_timer_pause" type="object" string="Pause"
                        attrs="{'invisible': ['|', '|', ('timesheet_timer_pause', '!=', False), ('timesheet_timer_start', '=', False), ('display_timesheet_timer', '=', False)]}"/>
                    <button class="btn-primary btn-info" name="action_timer_resume" type="object" string="Resume"
                        attrs="{'invisible': ['|', '|', ('timesheet_timer_pause', '=', False), ('timesheet_timer_start', '=', False), ('display_timesheet_timer', '=', False)]}"/>

                    <button class="btn-secondary" name="action_fsm_validate" type="object" string="Mark as done"
                        attrs="{'invisible': ['|', ('timesheet_ids', '!=', []), '|', '|', ('timesheet_timer_start', '!=', False), ('fsm_state', '!=', 'draft'), '&amp;', ('timesheet_ids', '!=', []), ('material_line_product_count', '!=', 0)]}"/>

                    <field name="fsm_to_invoice" invisible="1"/>
                    <button class="btn-primary" name="action_fsm_create_invoice" type="object" string="Create Invoice"
                        attrs="{'invisible': ['|', ('is_fsm', '=', False), '|', ('fsm_state', '=', 'draft'), '|', ('fsm_to_invoice', '=', True), '&amp;', ('material_line_product_count', '=', 0), ('total_hours_spent', '=', 0)]}" groups="sales_team.group_sale_salesman"/>
                    <button class="btn-secondary" name="action_fsm_create_invoice" type="object" string="Create Invoice"
                        attrs="{'invisible': ['|', ('is_fsm', '=', False), '|', ('fsm_state', '=', 'draft'), '&amp;', ('fsm_to_invoice', '=', False), '|', ('material_line_product_count', '!=', 0), ('total_hours_spent', '!=', 0)]}" groups="sales_team.group_sale_salesman"/>

                    <field name="timesheet_timer_start" widget="timesheet_timer" class="text-danger pull-right h2 mr-4 mt-2 font-weight-bold" attrs="{'invisible': [('timesheet_timer_start', '=', False)]}"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" name="action_fsm_view_material"
                            type="object" icon="fa-cart-plus" help="Add materials" attrs="{'invisible': [('is_fsm', '=', False)]}">
                            <div class="o_stat_info">
                                <span class="o_stat_value">
                                    <field name="material_line_product_count" widget="statinfo" string="Products" class="mr-1"/>
                                </span>
                                <field name="material_line_total_price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                <field name="currency_id" invisible="True"/>
                            </div>
                        </button>
                        <button class="oe_stat_button" name="action_view_timesheets" type="object" icon="fa-clock-o" help="Time recorded on this task" attrs="{'invisible': [('allow_timesheets', '=', False)]}">
                            <div class="o_stat_info">
                                <div>Time</div>
                                <span class="o_stat_value">
                                    <field name="total_hours_spent" widget="float_time" nolabel="1" class="mr-1" />
                                </span>
                            </div>
                        </button>
                        <button name="action_view_invoices" type="object" class="oe_stat_button" icon="fa-pencil-square-o" attrs="{'invisible': [('invoice_count', '=', 0)]}">
                            <field name="invoice_count" widget="statinfo" string="Invoices"/>
                        </button>
                    </div>
                    <div role="alert" class="alert-warning p-3 text-center"
                        attrs="{'invisible': ['|', ('is_fsm', '=', False), ('planning_overlap', '=', 0)]}">
                        <button name="action_fsm_view_overlapping_tasks" type="object" class="btn-link pr-1">
                            <field name="planning_overlap"/> tasks
                        </button>
                        <span class="align-middle">for this employee at the same time.</span>
                    </div>
                    <group>
                        <group>
                            <label for="name" class="oe_edit_only"/>
                            <field name="name" nolabel="1" class="oe_edit_only"/>
                            <field name="partner_id" required="1"
                                context="{'res_partner_search_mode': 'customer', 'show_address': 1, 'default_is_company': True, 'show_vat': True}"
                                options='{"always_reload": True}'
                                widget="res_partner_many2one"/>
                            <field name="partner_phone" widget="phone" attrs="{'invisible': [('partner_phone', '=', False)]}"/>
                            <field name="partner_mobile" widget="phone" attrs="{'invisible': [('partner_mobile', '=', False)]}" class="oe_edit_only"/>
                            <field name="partner_email" widget="email"  attrs="{'invisible': [('partner_email', '=', False)]}"/>
                            <field name="stage_id" invisible="1"/>
                        </group>
                        <group>
                            <label for="project_id" class="oe_edit_only"/>
                            <field name="project_id" domain="[('is_fsm', '=', True)]" required="True" nolabel="1" class="oe_edit_only" options="{'no_create': True, 'no_edit': True, 'no_open': 'True'}"/>
                            <label for="planned_date_begin" string="Date"/>
                            <div class="o_row">
                                <field name="planned_date_begin"/>
                                <span attrs="{'invisible': [('planned_date_end', '=', False)]}"> to </span>
                                <field name="planned_date_end"/>
                            </div>
                            <field name="user_id" options="{'no_open': True}"/>
                        </group>
                        <field name="description" colspan="2"/>
                        <field name="timesheet_ids" invisible="1"/>
                    </group>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Extends FSM form view to add "New Quotation" button -->
    <record id="project_task_view_form_fsm_quotation" model="ir.ui.view">
        <field name="name">view.form.fsm.inherit.quotation</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project_task_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='timesheet_timer_start']" position="after">
                <field name="is_fsm" invisible="1"/>
                <button class="btn-secondary" name="action_fsm_create_quotation" type="object" string="New Quotation" attrs="{'invisible': ['|', ('is_fsm', '=', False), ('timesheet_timer_start', '!=', False)]}"/>
            </xpath>
            <xpath expr="//button[@name='action_fsm_view_material']" position="after">
                <button name="action_fsm_view_quotations"
                    type="object"
                    class="oe_stat_button"
                    icon="fa fa-pencil-square-o"
                    attrs="{'invisible': ['|', ('is_fsm', '=', False), ('quotation_count', '=', 0)]}">
                    <field string="Quotation" name="quotation_count" widget="statinfo"/>
                </button>
            </xpath>
        </field>
        <field name="groups_id" eval="[(4, ref('sales_team.group_sale_salesman'))]"/>
    </record>

    <record id="project_task_view_list_fsm" model="ir.ui.view">
        <field name="name">project.task.tree.fsm</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <tree string="Tasks">
                <field name="name"/>
                <field name="project_id" invisible="context.get('user_invisible', False)"/>
                <field name="user_id" invisible="context.get('user_invisible', False)"/>
                <field name="company_id" groups="base.group_multi_company"/>
                <field name="planned_date_begin"/>
                <field name="planned_date_end"/>
            </tree>
        </field>
    </record>

    <record id="project_task_view_search_fsm" model="ir.ui.view">
        <field name="name">project.task.search.fsm</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <search string="Search planning">
                <field name="name" string="Tasks"/>
                <field name="partner_id" operator="child_of"/>
                <field name="user_id"/>
                <filter string="My Tasks" name="my_tasks" domain="[('user_id', '=', uid)]"/>
                <separator />
                <filter string="To schedule" name="schedule" domain="[
                    '|',
                    ('user_id', '=', False),
                    '&amp;',
                        ('planned_date_begin', '=', False),
                        ('planned_date_end', '=', False)
                ]" groups="industry_fsm.group_fsm_manager"/>
                <filter string="To Do" name="todo" domain="[('fsm_state', '=', 'draft'), ('user_id', '!=', False)]"/>
                <filter string="To Invoice" name="to_invoice" domain="[('fsm_to_invoice', '=', True), ('fsm_state', 'in', ['validated', 'sold']), ('is_fsm', '=', True )]" groups="sales_team.group_sale_salesman" />
                <separator />
                <filter name="planned_today" string="Planned for Today" domain="[
                    ('planned_date_begin','&lt;=', datetime.datetime.combine(context_today(), datetime.time(23,59,59))),
                    ('planned_date_begin','&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0)))]"/>
                <filter name="planned_future" string="Future" domain="[('planned_date_begin', '>=', datetime.datetime.combine(context_today(), datetime.time(0,0,0)))]"/>
                <group expand="0" string="Group By">
                    <filter string="Start Date" name="groupby_planned_date_begin" context="{'group_by': 'planned_date_begin:day'}"/>
                    <filter string="Responsible" name="groupby_user" context="{'group_by':'user_id'}"/>
                    <filter string="Stage" name="groupby_stage" context="{'group_by':'stage_id'}"/>
                    <filter string="Project" name="groupby_project" context="{'group_by':'project_id'}"/>
                    <filter string="Company" name="groupby_company" context="{'group_by':'company_id'}" groups="base.group_multi_company"/>
                </group>
            </search>
        </field>
    </record>

    <record id="project_task_view_calendar_fsm" model="ir.ui.view">
        <field name="name">project.task.calendar.fsm</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <calendar date_start="planned_date_begin" date_stop="planned_date_end" string="Tasks" mode="month" color="user_id" form_view_id="%(industry_fsm.project_task_view_form)d" event_open_popup="1">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="partner_zip"/>
            </calendar>
        </field>
    </record>

    <record id="project_task_view_kanban" model="ir.ui.view">
        <field name="name">project.task.kanban.fsm</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_kanban"/>
        <field name="mode">primary</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <xpath expr="//kanban" position="attributes">
                <attribute name="default_group_by">planned_date_begin:day</attribute>
                <attribute name="class">o_fsm_kanban</attribute>
            </xpath>
        </field>
    </record>

    <!--
        FSM Actions
    -->

    <!-- My Tasks: kanban action -->
    <record id="project_task_action_fsm" model="ir.actions.act_window">
        <field name="name">My Tasks</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">map,kanban,gantt,calendar,tree,form,activity</field>
        <field name="search_view_id" ref="project_task_view_search_fsm"/>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="context">{
            'fsm_mode': True,
            'search_default_my_tasks': True,
            'search_default_planned_future': True,
            'search_default_planned_today': True,
            'search_default_todo': True,
        }</field>
        <field name="help" type="html">
            <p class='o_view_nocontent_smiling_face'>No future Tasks planned</p>
            <p>You can create one for yourself by clicking on Create.</p>
        </field>
    </record>

    <record id="project_task_action_fsm_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="5"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="project_task_view_kanban"/>
        <field name="act_window_id" ref="project_task_action_fsm"/>
    </record>

    <record id="project_task_action_fsm_view_map" model="ir.actions.act_window.view">
        <field name="sequence" eval="10"/>
        <field name="view_mode">map</field>
        <field name="view_id" ref="project_enterprise.project_task_map_view"/>
        <field name="act_window_id" ref="project_task_action_fsm"/>
    </record>

    <record id="project_task_action_fsm_view_calendar" model="ir.actions.act_window.view">
        <field name="sequence" eval="20"/>
        <field name="view_mode">calendar</field>
        <field name="view_id" ref="industry_fsm.project_task_view_calendar_fsm"/>
        <field name="act_window_id" ref="project_task_action_fsm"/>
    </record>

     <record id="project_task_action_fsm_view_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="25"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project_task_view_list_fsm"/>
        <field name="act_window_id" ref="project_task_action_fsm"/>
    </record>

    <record id="project_task_action_fsm_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="30"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="project_task_view_form"/>
        <field name="act_window_id" ref="project_task_action_fsm"/>
    </record>

    <!-- My Tasks: map action -->
    <record id="project_task_action_fsm_map" model="ir.actions.act_window">
        <field name="name">Map</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">map,kanban,gantt,calendar,tree,form,activity</field>
        <field name="search_view_id" ref="project_task_view_search_fsm"/>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="context">{
            'search_default_my_tasks': True,
            'search_default_planned_future': True,
            'search_default_planned_today': True,
            'search_default_todo': True,
        }</field>
    </record>

    <record id="project_task_action_fsm_map_view_map" model="ir.actions.act_window.view">
        <field name="sequence" eval="5"/>
        <field name="view_mode">map</field>
        <field name="view_id" ref="project_enterprise.project_task_map_view"/>
        <field name="act_window_id" ref="project_task_action_fsm_map"/>
    </record>

    <record id="project_task_action_fsm_map_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="10"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="project_task_view_kanban"/>
        <field name="act_window_id" ref="project_task_action_fsm_map"/>
    </record>

    <record id="project_task_action_fsm_map_view_calendar" model="ir.actions.act_window.view">
        <field name="sequence" eval="20"/>
        <field name="view_mode">calendar</field>
        <field name="view_id" ref="industry_fsm.project_task_view_calendar_fsm"/>
        <field name="act_window_id" ref="project_task_action_fsm_map"/>
    </record>

    <record id="project_task_action_fsm_map_view_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="25"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project_task_view_list_fsm"/>
        <field name="act_window_id" ref="project_task_action_fsm_map"/>
    </record>

    <record id="project_task_action_fsm_map_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="30"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="project_task_view_form"/>
        <field name="act_window_id" ref="project_task_action_fsm_map"/>
    </record>

    <!-- All Tasks: main action -->
    <record id="project_task_action_all_fsm" model="ir.actions.act_window">
        <field name="name">To Do</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">kanban,gantt,calendar,map,pivot,graph,tree,form,activity</field>
        <field name="search_view_id" ref="project_task_view_search_fsm"/>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="context">{
            'fsm_mode': True,
            'search_default_groupby_stage': 1,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new task
            </p><p>
                There are currently no tasks, click on create to create one
            </p>
        </field>
    </record>

    <record id="project_task_action_all_fsm_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="5"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="project_task_view_kanban"/>
        <field name="act_window_id" ref="project_task_action_all_fsm"/>
    </record>

    <record id="project_task_action_all_fsm_view_calendar" model="ir.actions.act_window.view">
        <field name="sequence" eval="10"/>
        <field name="view_mode">calendar</field>
        <field name="view_id" ref="project_task_view_calendar_fsm"/>
        <field name="act_window_id" ref="project_task_action_all_fsm"/>
    </record>

    <record id="project_task_action_all_fsm_view_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="35"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project_task_view_list_fsm"/>
        <field name="act_window_id" ref="project_task_action_all_fsm"/>
    </record>

    <record id="project_task_action_all_fsm_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="40"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="project_task_view_form"/>
        <field name="act_window_id" ref="project_task_action_all_fsm"/>
    </record>

    <!-- All Tasks: to schedule action -->
    <record id="project_task_action_to_schedule_fsm" model="ir.actions.act_window">
        <field name="name">To Schedule</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">tree,kanban,gantt,calendar,map,pivot,graph,form,activity</field>
        <field name="search_view_id" ref="project_task_view_search_fsm"/>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="context">{
            'fsm_mode': True,
            'search_default_schedule': True,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No task to schedule
            </p><p>All tasks are scheduled</p>
        </field>
    </record>

    <record id="project_task_action_to_schedule_fsm_view_list" model="ir.actions.act_window.view">
        <field name="sequence" eval="5"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project_task_view_list_fsm"/>
        <field name="act_window_id" ref="project_task_action_to_schedule_fsm"/>
    </record>

    <record id="project_task_action_to_schedule_fsm_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="10"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="project_task_view_kanban"/>
        <field name="act_window_id" ref="project_task_action_to_schedule_fsm"/>
    </record>

    <record id="project_task_action_to_schedule_fsm_view_calendar" model="ir.actions.act_window.view">
        <field name="sequence" eval="20"/>
        <field name="view_mode">calendar</field>
        <field name="view_id" ref="project_task_view_calendar_fsm"/>
        <field name="act_window_id" ref="project_task_action_to_schedule_fsm"/>
    </record>

    <record id="project_task_action_to_schedule_fsm_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="45"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="project_task_view_form"/>
        <field name="act_window_id" ref="project_task_action_to_schedule_fsm"/>
    </record>

    <!-- All Tasks: to invoice action -->
    <record id="project_task_action_to_invoice_fsm" model="ir.actions.act_window">
        <field name="name">To Invoice</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">tree,kanban,gantt,calendar,map,pivot,graph,form,activity</field>
        <field name="search_view_id" ref="project_task_view_search_fsm"/>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="context">{
            'fsm_mode': True,
            'search_default_to_invoice': True,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No task to Invoice
            </p><p>All tasks were invoiced</p>
        </field>
    </record>

    <record id="project_task_action_to_invoice_fsm_view_list" model="ir.actions.act_window.view">
        <field name="sequence" eval="5"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project_task_view_list_fsm"/>
        <field name="act_window_id" ref="project_task_action_to_invoice_fsm"/>
    </record>

    <record id="project_task_action_to_invoice_fsm_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="10"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="project_task_view_kanban"/>
        <field name="act_window_id" ref="project_task_action_to_invoice_fsm"/>
    </record>

    <record id="project_task_action_to_invoice_fsm_view_calendar" model="ir.actions.act_window.view">
        <field name="sequence" eval="20"/>
        <field name="view_mode">calendar</field>
        <field name="view_id" ref="project_task_view_calendar_fsm"/>
        <field name="act_window_id" ref="project_task_action_to_invoice_fsm"/>
    </record>

    <record id="project_task_action_to_invoice_fsm_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="45"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="project_task_view_form"/>
        <field name="act_window_id" ref="project_task_action_to_invoice_fsm"/>
    </record>

    <!-- Planning : by users -->
    <record id="project_task_action_fsm_planning_groupby_user" model="ir.actions.act_window">
        <field name="name">Planning by User</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">gantt,kanban,tree,calendar,form,activity</field>
        <field name="search_view_id" ref="project_task_view_search_fsm"/>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="context" eval="{'search_default_groupby_user': 1, 'fsm_mode': 1, 'task_nameget_with_hours': 1}"/>
    </record>

    <record id="project_task_action_planning_groupby_user_gantt" model="ir.actions.act_window.view">
        <field name="sequence" eval="5"/>
        <field name="view_mode">gantt</field>
        <field name="view_id" ref="project_enterprise.project_task_view_gantt"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_user"/>
    </record>

    <record id="project_task_action_planning_groupby_user_fsm_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="10"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="project_task_view_kanban"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_user"/>
    </record>

    <record id="project_task_action_planning_groupby_user_fsm_view_list" model="ir.actions.act_window.view">
        <field name="sequence" eval="20"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project_task_view_list_fsm"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_user"/>
    </record>

    <record id="project_task_action_planning_groupby_user_fsm_view_calendar" model="ir.actions.act_window.view">
        <field name="sequence" eval="25"/>
        <field name="view_mode">calendar</field>
        <field name="view_id" ref="project_task_view_calendar_fsm"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_user"/>
    </record>

    <record id="project_task_action_planning_groupby_user_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="35"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="project_task_view_form"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_user"/>
    </record>

    <!-- Planning : by project -->
    <record id="project_task_action_fsm_planning_groupby_project" model="ir.actions.act_window">
        <field name="name">Planning by Project</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">kanban,tree,calendar,pivot,graph,activity</field>
        <field name="search_view_id" ref="project_task_view_search_fsm"/>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="context" eval="{'search_default_groupby_project': 1, 'fsm_mode': 1, 'task_nameget_with_hours': 1}"/>
    </record>

    <record id="project_task_action_planning_groupby_project_gantt" model="ir.actions.act_window.view">
        <field name="sequence" eval="5"/>
        <field name="view_mode">gantt</field>
        <field name="view_id" ref="project_enterprise.project_task_view_gantt"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_project"/>
    </record>

    <record id="project_task_action_planning_groupby_project_fsm_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="10"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="project_task_view_kanban"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_project"/>
    </record>

    <record id="project_task_action_planning_groupby_project_fsm_view_list" model="ir.actions.act_window.view">
        <field name="sequence" eval="20"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project_task_view_list_fsm"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_project"/>
    </record>

    <record id="project_task_action_planning_groupby_project_fsm_view_calendar" model="ir.actions.act_window.view">
        <field name="sequence" eval="25"/>
        <field name="view_mode">calendar</field>
        <field name="view_id" ref="project_task_view_calendar_fsm"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_project"/>
    </record>

    <record id="project_task_action_planning_groupby_project_fsm_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="35"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="project_task_view_form"/>
        <field name="act_window_id" ref="project_task_action_fsm_planning_groupby_project"/>
    </record>

    <!-- Settings actions -->
    <record id="res_config_settings_action_fsm" model="ir.actions.act_window">
        <field name="name">Settings</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">res.config.settings</field>
        <field name="view_mode">form</field>
        <field name="target">inline</field>
        <field name="context">{'module' : 'industry_fsm'}</field>
    </record>

    <record id="project_project_action_only_fsm" model="ir.actions.act_window" >
        <field name="name">Projects</field>
        <field name="res_model">project.project</field>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="view_id" ref="project.view_project"/>
        <field name="search_view_id" ref="project.view_project_project_filter"/>
        <field name="target">main</field>
        <field name="context">{
            'fsm_mode': True,
            'default_is_fsm': True,
        }</field>
    </record>

    <record id="product_action_fsm" model="ir.actions.act_window" >
        <field name="name">Products</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">kanban,tree,activity,form</field>
        <field name="domain">[('sale_ok', '=', True)]</field>
        <field name="context">{
            'fsm_mode': True,
            'search_default_filter_to_sell': True,
        }</field>
    </record>

    <!-- To invoice batch action -->
    <record id="project_task_server_action_batch_invoice_fsm" model="ir.actions.server">
        <field name="name">Create invoice</field>
        <field name="model_id" ref="industry_fsm.model_project_task"/>
        <field name="binding_model_id" ref="project.model_project_task"/>
        <field name="state">code</field>
        <field name="code">
            if records:
                action = records.action_fsm_create_invoice()
        </field>
    </record>

    <!--
        FSM Menus
    -->

    <menuitem id="fsm_menu_root"
        name="Field Service"
        sequence="25"
        web_icon="industry_fsm,static/description/icon.png"
        groups="industry_fsm.group_fsm_user"/>

    <menuitem id="fsm_tasks_menu"
        name="My Tasks"
        sequence="10"
        parent="fsm_menu_root"
        groups="industry_fsm.group_fsm_user"/>

        <menuitem id="fsm_menu_tasks_kanban"
            name="Tasks"
            action="project_task_action_fsm"
            sequence="10"
            parent="fsm_tasks_menu"
            groups="industry_fsm.group_fsm_user"/>

        <menuitem id="fsm_menu_tasks_map"
            name="Map"
            action="project_task_action_fsm_map"
            sequence="20"
            parent="fsm_tasks_menu"
            groups="industry_fsm.group_fsm_user"/>

    <menuitem id="fsm_menu_all_tasks_root"
        name="All Tasks"
        sequence="15"
        parent="fsm_menu_root"
        groups="industry_fsm.group_fsm_manager" />

        <menuitem id="fsm_menu_all_tasks_todo"
            name="All Tasks"
            action="project_task_action_all_fsm"
            sequence="10"
            parent="industry_fsm.fsm_menu_all_tasks_root"
            groups="industry_fsm.group_fsm_manager" />

        <menuitem id="fsm_menu_all_tasks_schedule"
            name="To Schedule"
            action="project_task_action_to_schedule_fsm"
            sequence="20"
            parent="industry_fsm.fsm_menu_all_tasks_root"
            groups="industry_fsm.group_fsm_manager" />

        <menuitem id="fsm_menu_all_tasks_invoice"
            name="To Invoice"
            action="project_task_action_to_invoice_fsm"
            sequence="30"
            parent="industry_fsm.fsm_menu_all_tasks_root"
            groups="sales_team.group_sale_salesman"/>

    <menuitem id="fsm_menu_planning"
        name="Planning"
        sequence="20"
        parent="fsm_menu_root"
        groups="industry_fsm.group_fsm_manager"/>

        <menuitem id="project_task_menu_planning_by_user_fsm"
            name="By User"
            sequence="10"
            action="industry_fsm.project_task_action_fsm_planning_groupby_user"
            parent="fsm_menu_planning"
            groups="industry_fsm.group_fsm_manager"/>

        <menuitem id="project_task_menu_planning_by_project_fsm"
            name="By Project"
            sequence="15"
            action="industry_fsm.project_task_action_fsm_planning_groupby_project"
            parent="fsm_menu_planning"
            groups="industry_fsm.group_fsm_manager"/>

    <menuitem id="fsm_menu_reporting"
        name="Reporting"
        sequence="40"
        parent="fsm_menu_root"
        groups="industry_fsm.group_fsm_manager"/>

        <menuitem id="fsm_menu_reporting_task_analysis"
            name="Tasks Analysis"
            sequence="10"
            action="project_task_user_action_report_fsm"
            parent="industry_fsm.fsm_menu_reporting"
            groups="industry_fsm.group_fsm_manager"/>

    <menuitem id="fsm_menu_settings"
        name="Configuration"
        sequence="50"
        parent="industry_fsm.fsm_menu_root"
        groups="industry_fsm.group_fsm_manager"/>

        <menuitem id="fsm_menu_settings_res_config"
            name="Settings"
            parent="fsm_menu_settings"
            sequence="0"
            action="industry_fsm.res_config_settings_action_fsm"
            groups="base.group_system"/>

        <menuitem id="fsm_menu_settings_project"
            name="Projects"
            sequence="10"
            action="project_project_action_only_fsm"
            parent="fsm_menu_settings"
            groups="industry_fsm.group_fsm_manager"/>

        <menuitem id="fsm_menu_settings_product"
            name="Products"
            sequence="20"
            action="product_action_fsm"
            parent="fsm_menu_settings"
            groups="sales_team.group_sale_salesman"/>

</odoo>
