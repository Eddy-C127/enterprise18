<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Sources
        https://www.ato.gov.au/
        https://oac.chris21.com/OAC_ichrisp/Help/ichrisUG/646250.htm
    -->
    <!-- Schedule 3 - Tax table for actors, variety artists and other entertainers  -->

    <!-- BASIC SALARY, sequence 1 -->

    <record id="l10n_au_ote_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_ote"/>
        <field name="name">Ordinary Time Earnings</field>
        <field name="code">OTE</field>
        <field name="sequence">20</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
ote_inputs = payslip.input_line_ids.filtered(lambda i: i.input_type_id.l10n_au_is_ote)
ote_worked_day = payslip.worked_days_line_ids.filtered(lambda l: l.work_entry_type_id.l10n_au_is_ote)
result = sum(ote_inputs.mapped('amount')) + sum(ote_worked_day.mapped('amount'))
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
        <field name="appears_on_payslip">False</field>
    </record>

    <!-- Taxable Salary, Sequence 100 -->
    <function model="hr.salary.rule" name="write">
        <value model="hr.salary.rule" search="[
            ('struct_id', '=', ref('l10n_au_hr_payroll.hr_payroll_structure_au_actor')),
            ('code', '=', 'GROSS')]"/>
        <value eval="{
            'amount_python_compute': &quot;result = categories['BASIC'] + categories['ALW']&quot;
        }"/>
    </function>

    <!-- Sources
        https://www.ato.gov.au/
        https://oac.chris21.com/OAC_ichrisp/Help/ichrisUG/646250.htm
    -->
    <!-- the 3 following rules take advantage of the fact that any variable declared in the compute function
    is added to the global dictionnary. Because we need to separate taxable and non-taxable components of the
    ETP payment, the variables are calculated once but used in different rules.-->
    <record id="l10n_au_termination_etp_gross_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="hr_payroll.BASIC"/>
        <field name="name">Gross ETP</field>
        <field name="code">ETP.GROSS</field>
        <field name="sequence">101</field>
        <field name="condition_select">python</field>
        <field name="condition_python">result = payslip.l10n_au_is_termination and any(payslip.input_line_ids.filtered(lambda l: l.input_type_id.l10n_au_is_etp))</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
etp_withholding, tax_free_component = payslip._l10n_au_compute_termination_withhold(employee, ytd_total)
result = sum(payslip.input_line_ids.filtered(lambda l: l.input_type_id.l10n_au_is_etp).mapped('amount'))
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
    </record>

    <record id="l10n_au_termination_etp_tax_free_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_tax_free_component"/>
        <field name="name">Tax-Free ETP</field>
        <field name="code">TAX.FREE</field>
        <field name="sequence">102</field>
        <field name="condition_select">python</field>
        <field name="condition_python">result = payslip.l10n_au_is_termination and any(payslip.input_line_ids.filtered(lambda l: l.input_type_id.l10n_au_is_etp))</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = tax_free_component
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
        <field name="appears_on_payslip">False</field>
    </record>

    <record id="l10n_au_termination_etp_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_etp_base"/>
        <field name="name">Base ETP</field>
        <field name="code">ETP.BASE</field>
        <field name="sequence">103</field>
        <field name="condition_select">python</field>
        <field name="condition_python">result = payslip.l10n_au_is_termination and any(payslip.input_line_ids.filtered(lambda l: l.input_type_id.l10n_au_is_etp))</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = sum(payslip.input_line_ids.filtered(lambda l: l.input_type_id.l10n_au_is_etp).mapped('amount')) - tax_free_component
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
        <field name="appears_on_payslip">False</field>
    </record>

    <record id="l10n_au_termination_leave_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="hr_payroll.BASIC"/>
        <field name="name">Unused Leaves</field>
        <field name="code">ETP.LEAVE.GROSS</field>
        <field name="sequence">105</field>
        <field name="condition_select">python</field>
        <field name="condition_python">result = payslip.l10n_au_is_termination</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
leave_amount, _, _ = payslip._l10n_au_compute_unused_leaves_withhold(categories['BASIC'])
result = leave_amount
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
    </record>

    <record id="l10n_au_withholding_actors_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_withholding"/>
        <field name="name">PAYG Withholding</field>
        <field name="code">WITHHOLD</field>
        <field name="sequence">108</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
coefficients = payslip._rule_parameter("l10n_au_withholding_coefficients")["actor"]
result = -payslip._l10n_au_compute_withholding_amount(categories['GROSS'] * contract.l10n_au_performances_per_week, "weekly", coefficients)
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
    </record>

    <record id="l10n_au_allowance_withholding_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_withholding"/>
        <field name="name">Withholding for allowances</field>
        <field name="code">WITHHOLD.ALW</field>
        <field name="sequence">132</field>
        <field name="condition_select">python</field>
        <field name="condition_python">result = payslip.l10n_au_allowance_withholding</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">result = -payslip.l10n_au_allowance_withholding</field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
        <field name="appears_on_payroll_report">False</field>
    </record>

    <record id="l10n_au_termination_etp_withholding_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_withholding"/>
        <field name="name">ETP Withholding</field>
        <field name="code">ETP.WITHHOLD</field>
        <field name="sequence">160</field>
        <field name="condition_select">python</field>
        <field name="condition_python">result = payslip.l10n_au_is_termination and any(payslip.input_line_ids.filtered(lambda l: l.input_type_id.l10n_au_is_etp))</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = -etp_withholding
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
    </record>

    <record id="l10n_au_termination_leave_withholding_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_withholding"/>
        <field name="name">Unused Leaves Withholding</field>
        <field name="code">ETP.LEAVE.WITHHOLD</field>
        <field name="sequence">162</field>
        <field name="condition_select">python</field>
        <field name="condition_python">result = payslip.l10n_au_is_termination</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
_, leave_withholding, _ = payslip._l10n_au_compute_unused_leaves_withhold(categories['BASIC'])
result = -leave_withholding
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
    </record>

    <record id="l10n_au_withholding_net_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_net_withholding"/>
        <field name="name">Total Withholding Amount</field>
        <field name="code">WITHHOLD.TOTAL</field>
        <field name="sequence">164</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = categories['WITHHOLD'] + min(-categories['WITHHOLD'], categories["WITHHOLD.OFFSET"])
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
    </record>

    <!-- Attachment of Salary, Sequence 174 -->
    <!-- Assignment of Salary, Sequence 174 -->
    <!-- Child Support (Standard), Sequence 174 -->

    <record id="l10n_au_child_support_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_child_support"/>
        <field name="name">Child Support</field>
        <field name="code">CHILD.SUPPORT</field>
        <field name="sequence">185</field>
        <field name="condition_select">python</field>
        <field name="condition_python">result = employee.l10n_au_child_support_deduction or employee.l10n_au_child_support_garnishee</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
net_salary = categories['BASIC'] + categories['ALW'] + categories['DED']
result = -payslip._l10n_au_compute_child_support(net_salary)
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
    </record>

    <!-- Deduction, Sequence 198 -->
    <!-- Reimbursement, Sequence 199 -->

    <!-- Allowances not in Gross -->
    <record id="l10n_au_allowance_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="hr_payroll.ALW"/>
        <field name="name">Allowance</field>
        <field name="sequence">199</field>
        <field name="code">ALW</field>
        <field name="condition_select">python</field>
        <field name="condition_python">result = payslip.input_line_ids.filtered(lambda x: x.input_type_id.l10n_au_is_allowance)</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
allowances = payslip.input_line_ids.filtered(lambda x: x.input_type_id.l10n_au_is_allowance)
result = sum(allowances.mapped('amount'))
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
    </record>

    <!-- Net Salary, Sequence 200 -->

    <record id="l10n_au_super_contribution_structure_3" model="hr.salary.rule">
        <field name="category_id" ref="l10n_au_hr_payroll.rule_category_super_contribution"/>
        <field name="name">Super Guarantee</field>
        <field name="code">SUPER</field>
        <field name="sequence">230</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
rate = payslip._rule_parameter("l10n_au_withholding_super")
result = categories['OTE'] * rate/100
        </field>
        <field name="struct_id" ref="l10n_au_hr_payroll.hr_payroll_structure_au_actor"/>
    </record>
</odoo>
