<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="assets_frontend" inherit_id="website.assets_frontend" name="Subscription Manager">
      <xpath expr="." position="inside">
          <link rel='stylesheet' href='/website_subscription/static/src/css/website_subscription.less'/>
          <script type="text/javascript" src="/website_subscription/static/src/js/website_subscription.js"></script>
      </xpath>
    </template>

    <template id="assets_backend" inherit_id="website.assets_backend" name="Website Subscription Backend Assets">
      <xpath expr="." position="inside">
          <link rel='stylesheet' href='/website_subscription/static/src/css/sale_subscription_backend.less'/>
      </xpath>
    </template>


    <!-- Chatter templates -->
    <template id="chatter_add_option">
        <div>Option added by customer</div>
        <div>&amp;bull; <b>Option</b>: <t t-esc="new_option.product_id.product_tmpl_id.name"/></div>
        <div>&amp;bull; <b>Price</b>: <t t-esc="price"/></div>
        <div>&amp;bull; <b>Sales Order</b>: None</div>
    </template>

    <template id="chatter_remove_option">
        <div>Option removed by customer</div>
        <div>&amp;bull; <b>Option</b>: <t t-esc="remove_option.product_id.product_tmpl_id.name"/></div>
    </template>

    <template id="chatter_add_paid_option">
        <div>New Option added by Sales Order confirmation</div>
            <t t-foreach="lines" t-as="line">
                <div>&amp;bull; <b>Option</b>: <t t-esc="line.product_id.product_tmpl_id.name"/></div>
                <div>&amp;bull; <b>Sales Order</b>: <t t-esc="line.order_id.name"/></div>
                <div>&amp;bull; <b>Recurring Price</b>: <t t-esc="line.price_unit"/></div>
                <div>&amp;bull; <b>Discount (partial invoicing period)</b>: <t t-esc="line.discount"/></div>
                <div>&amp;bull; <b>Discounted Price</b>: <t t-esc="line.price_subtotal"/></div>
                <br/>
            </t>
    </template>

    <!-- Specific Subscription Page -->

    <template id="subscription" name="Subscription">
        <t t-call="website_portal.portal_layout">
            <div class="oe_structure"/>
            <div class="row oe_website_contract">
                <div class="col-md-8">
                    <h3 class="page-header">Subscription <span t-field="account.name"/>
                        <t t-call="website_portal.record_pager"/>
                        <small class="pull-right">
                            <t t-if="account.state == 'open'">
                                <span class="label label-success"><i class="fa fa-fw fa-check"/> In Progress</span>
                            </t>
                            <t t-if="account.state == 'pending'">
                                <span class="label label-warning"><i class="fa fa-fw fa-refresh"/> To Renew</span>
                            </t>
                            <t t-if="account.state == 'close'">
                                <span class="label label-default"><i class="fa fa-fw fa-remove"/> Closed</span>
                            </t>
                        </small>
                        <a class="btn btn-info btn-sm css_editable_mode_hidden hidden-print" t-att-href="'/web#model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (account._name, account.id, action)" t-ignore="true" groups="sale_subscription.group_sale_subscription_view">Back</a>
                    </h3>
                    <div t-if="message" t-att-class="'alert ' + message_class" role="alert">
                        <p t-esc="message"/>
                    </div>
                        <div t-field="account.partner_id" t-field-options='{
                            "widget": "contact",
                            "fields": [
                                "name",
                                "address",
                                "phone",
                                "email"]}'/>
                        <div t-if="user.partner_id == account.partner_id">
                            <a class="small" t-attf-href="/my/account?redirect=/my/subscription/#{account.id}/#{account.uuid}">(Wrong address?)</a>
                        </div>
                    <div class="oe_structure"/>
                    <table class="table mt32" id="wc-account-table">
                        <thead>
                            <tr class="active"><th/><th/><th>Quantity</th><th>Unit Price</th><th>Subtotal</th></tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <td/><td/>
                                <td colspan="2">
                                    <p class="mb0">Subtotal:</p>
                                    <p class="mb0" t-if="user.partner_id == account.partner_id">
                                        <t t-if="account.partner_id.country_id">
                                        <a class="small" t-attf-href="/my/account?redirect=/my/subscription/#{account.id}/#{account.uuid}">(Not in <span t-field="account.partner_id.country_id" data-oe-readonly="1"/>?)</a>
                                        </t>
                                        Taxes:
                                    </p>
                                    <p class="mb0" t-if="user.partner_id != account.partner_id">
                                        <abbr title="You need to be logged in as this subscription's customer to change country">Taxes</abbr>:
                                    </p>
                                    <p class="mb0"><strong>Total:</strong></p>
                                </td>
                                <td>
                                    <p class="mb0" t-field="account.recurring_total" t-field-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/>
                                    <p class="mb0" t-field="account.recurring_amount_tax" t-field-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/>
                                    <strong><p class="mb0" t-field="account.recurring_amount_total" t-field-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></strong>
                                </td>
                            </tr>
                        </tfoot>
                        <tbody>
                            <t t-if="not account.template_id">
                                <tr t-foreach="account.recurring_invoice_line_ids" t-as="line">
                                    <td class="line-description"><span t-field="line.name"/></td>
                                    <td/>
                                    <td><t t-esc="line.quantity"/> <span t-field="line.uom_id" data-oe-readonly="1"/></td>
                                    <td t-if="not line.discount"><span t-esc="line.price_unit" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></td>
                                    <td t-if="line.discount">
                                        <s t-esc="line.price_unit" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/><br/>
                                        <div><strong t-esc="line.price_unit*(100.0-line.discount)/100.0" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></div>
                                    </td>
                                    <td><span t-esc="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></td>
                                    <td/>
                                </tr>
                            </t>

                            <tr t-foreach="account.recurring_mandatory_lines" t-as="line">
                                <td class="line-description"><span t-field="line.name"/></td>
                                <td/>
                                <td><t t-esc="line.quantity"/> <span t-field="line.uom_id" data-oe-readonly="1"/></td>
                                <td t-if="not line.discount"><span t-esc="line.price_unit" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></td>
                                <td t-if="line.discount">
                                    <s t-esc="line.price_unit" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/><br/>
                                    <div><strong t-esc="line.price_unit*(100.0-line.discount)/100.0" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></div>
                                </td>
                                <td><span t-esc="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></td>
                            </tr>
                            <tr t-foreach="account.recurring_option_lines" t-as="line">
                                <td class="line-description"><span t-field="line.name"/></td>
                                <td>
                                    <a data-toggle="modal"
                                       t-attf-data-target="#wc-modal-remove-#{line.get_template_option_line().id}"
                                       href=""
                                       t-if="(line.get_template_option_line().portal_access in ['both'] or is_salesman) and account.state!='close'">
                                        Remove
                                    </a>
                                    <t t-call="website_subscription.modal_remove"/>
                                </td>
                                <td><t t-esc="line.quantity"/> <span t-field="line.uom_id" data-oe-readonly="1"/></td>
                                <td t-if="not line.discount"><span t-esc="line.price_unit" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></td>
                                <td t-if="line.discount">
                                    <s t-esc="line.price_unit" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/><br/>
                                    <div><strong t-esc="line.price_unit*(100.0-line.discount)/100.0" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></div>
                                </td>                                        <td><span t-esc="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></td>
                            </tr>
                            <tr t-foreach="account.recurring_custom_lines" t-as="line">
                                <td class="line-description"><span t-field="line.name"/></td>
                                <td/>
                                <td><t t-esc="line.quantity"/> <span t-field="line.uom_id" data-oe-readonly="1"/></td>
                                <td t-if="not line.discount"><span t-esc="line.price_unit" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></td>
                                <td t-if="line.discount">
                                    <s t-esc="line.price_unit" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/><br/>
                                    <div><strong t-esc="line.price_unit*(100.0-line.discount)/100.0" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></div>
                                </td>
                                <td><span t-esc="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": pricelist.currency_id}'/></td>
                            </tr>
                        </tbody>
                    </table>
                    <div t-if="account.state in ['pending','close']" t-attf-class="alert alert-#{'warning' if account.state=='pending' else 'danger'}" role="alert" id="payment_message">
                        <p t-if="account.state == 'pending'" id='warning_pending'>Your subscription is waiting for payment.</p>
                        <div t-if="payment_mandatory and account.state!='open'">
                            <p id="wc_warning_closed" t-if="account.state == 'close'">Your subscription is closed.
                                <t t-if="missing_periods == 1">If you wish to reopen it, you can pay your invoice for the current invoicing period.</t>
                                <t t-if="missing_periods &gt; 1">If you wish to reopen it, the <t t-esc="missing_periods"/> missing payments (from <span t-field="account.recurring_next_date"/> to this day) will be automatically processed.</t>
                            </p>
                            <form method="post" class="mt16 clearfix" id="wc-payment-form" t-attf-action="/my/subscription/payment/#{account.id}/#{account.uuid}">
                                <input class="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <div class="form-group">
                                    <select class="form-control" name="pay_meth">
                                        <option value="-2">Current: <span t-esc="account.payment_token_id.name"/></option>
                                        <option value="-1" t-att-selected="'selected' if not account.payment_token_id else ''">New</option>
                                        <optgroup label="All Payment Methods">
                                            <t t-foreach="part_pms" t-as="pm">
                                                <option  t-att-value="pm.id" t-esc="pm.name"/>
                                            </t>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="clearfix"></div>
                                <button type="submit" t-attf-class="mt8 btn btn-primary btn-sm pull-right contract-submit #{'hidden' if not account.payment_token_id else ''}">Pay Now</button>
                            </form>
                            <div id="new_payment_method" t-if="account.state in ['pending', 'close']" t-attf-class="#{'hidden' if account.payment_token_id else ''} clearfix">
                                <div t-if="error_message" class="alert alert-danger">
                                  <t t-foreach="error_message" t-as="err"><t t-esc="err"/><br /></t>
                                </div>
                                <div t-if='len(acquirers)>1'>
                                    <label class="control-label" for="pm_acquirer_id">Acquirer</label>
                                    <select name="pm_acquirer_id" class="form-control">
                                        <t t-foreach="acquirers" t-as="acquirer">
                                            <option t-att-value="acquirer.id" t-esc="acquirer.name"/>
                                        </t>
                                    </select>
                                </div>
                                <t t-foreach="acquirers" t-as="acquirer">
                                    <div t-raw="acquirer.form" t-att-data-acquirer-id="acquirer.id" t-attf-class="acquirer #{'hidden' if acquirer!=acquirers[0] else ''}"/>
                                </t>
                            </div>
                        </div>
                    </div>
                    <t t-if="account.recurring_inactive_lines">
                        <h3 class="page-header">Extra Options</h3>
                        <div class="oe_structure"/>
                        <table class="table table-default table-condensed table-hover" id="wc-option-table">
                            <thead>
                                <tr class='active'><th>Name</th><th/><th>Price</th></tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="inactive_options" t-as="line">
                                    <t t-if="line.portal_access != 'invisible'">
                                        <td><span t-field="line.name"/></td>
                                        <td>
                                            <a data-toggle="modal"
                                               t-attf-data-target="#wc-modal-add-#{line.id}"
                                               href=""
                                               t-if="line.portal_access in ['both', 'upgrade'] and account.state!='close'">
                                                Add
                                            </a>
                                            <t t-call="website_subscription.modal_add"/>
                                        </td>
                                        <td>
                                            <span t-esc="line.with_context(pricelist_id=pricelist.id).price" t-options="{'widget': 'monetary', 'display_currency': pricelist.currency_id}"/> / <span t-field="line.uom_id" data-oe-readonly="1"/>
                                        </td>
                                    </t>
                                </tr>
                            </tbody>
                        </table>
                    </t>
                    <t t-if="account.description">
                        <div class="oe_structure"/>
                        <h3 class="page-header">Terms and conditions</h3>
                        <div t-field="account.description"/>
                    </t>
                </div>
                <div class="col-md-3 col-md-offset-1">
                    <div class="oe_structure"/>
                    <div>
                        <h3 class="page-header">Your Plan</h3>
                        <div>Current plan: <span t-field="template.name"/></div>
                        <div>Reference: <span t-field="account.code"/></div>
                        <div>Start date: <span t-field="account.date_start"/></div>
                        <div t-if="account.date">Valid until: <span t-field="account.date"/></div>
                        <div>Billing:
                            Every
                            <t t-esc="account.recurring_interval"/>
                            <t t-if="account.recurring_rule_type=='daily'">
                                day(s)
                            </t>
                            <t t-if="account.recurring_rule_type=='weekly'">
                                week(s)
                            </t>
                            <t t-if="account.recurring_rule_type=='monthly'">
                                month(s)
                            </t>
                            <t t-if="account.recurring_rule_type=='yearly'">
                                year(s)
                            </t>
                        </div>
                        <div>Next invoice: <span t-field="account.recurring_next_date"/></div>
                        <a t-if="account.state=='open' and account.template_id and display_change_plan" class="mt8 btn btn-primary btn-sm" t-att-href="'/my/subscription/'+str(account.id)+'/change'+'?uuid='+str(account.uuid)">Change plan</a>
                    </div>
                    <div t-if="account.user_id">
                        <a name="wc-your-contact"/>
                        <h3 class="page-header">Subscription Manager</h3>
                        <div t-field="account.user_id" t-field-options='{
                            "widget": "contact",
                            "fields": [
                                "name",
                                "phone",
                                "email"]}'/>
                    </div>
                    <div t-if="display_close" >
                        <h3 class="page-header">Close your account</h3>
                        <p>If you close your account, it will remain active until your next invoice date (<span id="wc-next-invoice" t-field="account.recurring_next_date"/>). After this date, you can reopen your account up to <span t-esc="account.recurring_interval"/>
                                    <t t-if="account.recurring_rule_type=='daily'">
                                        day(s)
                                    </t>
                                    <t t-if="account.recurring_rule_type=='weekly'">
                                        week(s)
                                    </t>
                                    <t t-if="account.recurring_rule_type=='monthly'">
                                        month(s)
                                    </t>
                                    <t t-if="account.recurring_rule_type=='yearly'">
                                        year(s)
                                    </t>
                        by paying your invoice.</p>
                        <a class="mt8 btn btn-default btn-sm" href="" id="wc-close-account" data-toggle="modal" data-target="#wc-modal-close">Close your account</a>
                    </div>
                    <div class="oe_structure"/>
                </div>
            </div>
            <div class="oe_structure"/>

            <div class="modal fade" id="wc-modal-close" t-if="display_close">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Close your subscription</h4>
                        </div>
                        <form method="post" t-attf-action="/my/subscription/#{account.id}/close/?uuid=#{account.uuid}">
                            <input class="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <div class="modal-body">
                                <p>If you confirm, you subscription will be closed right away. Your current invoicing period is valid until <span t-field="account.recurring_next_date"/>.</p>
                                <p>We always listen to our customer. Could you specify the reason for cancelling your subscription?</p>
                                <div class="form-group">
                                    <select class="form-control" name="close_reason_id">
                                        <t t-foreach="close_reasons" t-as="close_reason">
                                            <option  t-att-value="close_reason.id" t-esc="close_reason.name"/>
                                        </t>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <textarea class="form-control" name="closing_text" style="width: 100%;" rows="4"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                <button class="btn btn-primary contract-submit">Confirm</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </t>
    </template>


    <template id="modal_remove">
        <div class="modal fade" t-attf-id="wc-modal-remove-#{line.get_template_option_line().id}">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" t-attf-action="/my/subscription/#{account.id}/remove_option/?uuid=#{account.uuid}">
                        <input class="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <div class="modal-header">
                            <h4 class="modal-title">Confirm Option Removal</h4>
                        </div>
                        <div class="modal-body">
                            <p>The following option will be removed from your next invoice:</p>
                            <p class="line-description" t-field="line.name"/>
                            <input name="remove_option_id" type="hidden" t-att-value="line.get_template_option_line().id" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button class="btn btn-primary contract-submit">Confirm</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </template>

    <template id="modal_add">
        <div class="modal fade" t-attf-id="wc-modal-add-#{line.id}">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Confirm Option</h4>
                    </div>
                    <div class="modal-body">
                        <p>The following option will be added to your next invoice:</p>
                        <p class="line-description" t-field="line.name"/>
                        <t t-set="pricelist" t-value="request.website.get_current_pricelist()"/>
                        <p t-if="line.with_context(pricelist_id=pricelist.id).price&gt;0.0 and template.partial_invoice">You will be invoiced for the remaining of this invoicing period (from today to <span t-field="account.recurring_next_date" />).</p>
                    </div>
                    <div class="modal-footer">
                        <form method="post" t-attf-action="/my/subscription/#{account.id}/pay_option"
                              t-if="line.with_context(pricelist_id=pricelist.id).price&gt;0.0 and template.partial_invoice">
                            <input class="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <input name="new_option_id" type="hidden" t-att-value="line.id" />
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button class="btn btn-primary contract-submit">Confirm</button>
                        </form>
                        <form method="post" t-attf-action="/my/subscription/#{account.id}/add_option/?uuid=#{account.uuid}" t-if="line.with_context(pricelist_id=pricelist.id).price==0.0 or not template.partial_invoice">
                            <input class="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <input name="new_option_id" type="hidden" t-att-value="line.id" />
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button class="btn btn-primary contract-submit">Confirm</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Modify website_portal templates -->
    <template id="portal_my_home_menu_subscription" name="Portal layout : subscription menu entry" inherit_id="website_portal.portal_layout" priority="10">
        <xpath expr="//ol[contains(@class,'o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'subscription' or account">
                <a t-if="account" t-attf-href="/my/subscription?{{ keep_query() }}">
                    My Subscriptions
                </a>
                <t t-else="">
                    My Subscriptions
                </t>
            </li>
        </xpath>
    </template>

    <template id="portal_my_home_subscription" name="Portal My Home : subscription entries" inherit_id="website_portal.portal_my_home" priority="10">
        <xpath expr="//div[contains(@class,'o_my_home_content')]" position="inside">
            <h3 t-if="subscription_count" class="page-header">
                <a href="/my/subscription">My Susbcription
                    <span class="badge ml8" t-esc="subscription_count"/>
                </a>
            </h3>
        </xpath>
    </template>

    <template id="portal_my_subscriptions" name="My Subscriptions">
        <t t-call="website_portal.portal_layout">
            <h3 class="page-header">
                My Subscriptions
                <t t-call="website_portal.portal_searchbar"/>
            </h3>
            <t t-if="not accounts">
                <p>You don't have any subscriptions yet.</p>
            </t>
            <t t-if="accounts">
                <div class="table-responsive"><table class="table table-hover status_table">
                    <thead>
                        <tr class="active">
                            <th>Name</th>
                            <th/>
                            <th></th>
                        </tr>
                    </thead>
                    <t t-foreach="accounts" t-as="account">
                        <tr>
                            <td>
                                <a t-att-href="'/my/subscription/'+str(account.id)+'/'+str(account.uuid)+'?'+keep_query()"><t t-esc="account.name"/></a>
                            </td>
                            <td id="subscription_state">
                                <t t-if="account.state == 'open'">
                                    <span class="label label-success"><i class="fa fa-fw fa-check"/> In Progress</span>
                                </t>
                                <t t-if="account.state == 'pending'">
                                    <span class="label label-warning"><i class="fa fa-fw fa-refresh"/> To Renew</span>
                                </t>
                                <t t-if="account.state == 'close'">
                                    <span class="label label-default"><i class="fa fa-fw fa-remove"/> Closed</span>
                                </t>
                            </td>
                            <td><span t-esc="account.recurring_total" t-options="{'widget': 'monetary', 'display_currency': account.pricelist_id.currency_id}"/></td>
                        </tr>
                    </t>
                </table></div>
                <div class="col-md-12 text-center">
                    <t t-call="website.pager"/>
                </div>
            </t>
        </t>
    </template>

</odoo>
