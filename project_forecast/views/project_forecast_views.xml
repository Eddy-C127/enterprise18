<?xml version="1.0" encoding="utf-8"?>
<odoo><data>

  <!-- wizards -->
    <act_window id="project_forecast_repeat_forecast_wizard"
            name="Repeat forecast"
            res_model="project.forecast.repeat"
            view_mode="form"
            target="new" />


    <record id="project_forecast_create_wizard_action" model="ir.actions.act_window" >
        <field name="name">Create forecasts</field>
        <field name="res_model">project.forecast.create</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

  <!-- tree view -->
  <record id="project_forecast_view_tree" model="ir.ui.view">
    <field name="name">project.forecast.tree</field>
    <field name="model">project.forecast</field>
    <field name="arch" type="xml">
      <tree string="Forecast List">
        <field name="employee_id"/>
        <field name="project_id"/>
        <field name="task_id"/>
        <field name="company_id" groups="base.group_multi_company"/>
        <field name="resource_time"/>
      </tree>
    </field>
  </record>

  <!-- form view -->
  <record id="project_forecast_view_form" model="ir.ui.view">
    <field name="name">project.forecast.form</field>
    <field name="model">project.forecast</field>
    <field name="arch" type="xml">
        <form string="Forecast Form">
            <header>
                <button name="%(project_forecast_repeat_forecast_wizard)d" class="btn btn-primary" type="action" string="repeat" attrs="{'invisible': ['|' ,('recurrency_id', '!=', False), ('id', '=', False)]}" />
            </header>
            <sheet string="Project Forecast">
                <div class="oe_button_box" name="button_box"
                        invisible="context.get('view_grid_add_line')">
                    <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive">
                        <field name="active" widget="boolean_button" options='{"terminology": "archive"}'/>
                    </button>
                </div>
                <field name="recurrency_id" invisible='1'></field>
                <group>
                    <group>
                        <field name="employee_id" string="Assign To"/>
                        <field name="project_id"
                            context="{'default_allow_forecast': True}"/>
                        <field name="task_id"
                            context="{'default_project_id': project_id,
                                      'default_employee_id': employee_id}"/>
                    </group>
                    <group>
                        <field name="start_datetime" string="Start date"/>
                        <field name="end_datetime" string="End date"/>
                    </group>
                    <group>
                        <field name="resource_hours" readonly="0" widget="float_time"/>
                        <field name="resource_time" />
                    </group>
                </group>
            </sheet>
        </form>
    </field>
  </record>

  <!-- search view -->
  <record id="project_forecast_view_search" model="ir.ui.view">
    <field name="name">project.forecast.search</field>
    <field name="model">project.forecast</field>
    <field name="arch" type="xml">
      <search>
        <field name="project_id"/>
        <field name="task_id"/>
        <filter name="my_activities" string="My Activities"
                domain="[('user_id', '=', uid)]"/>
        <filter name="my_projects" string="My Projects"
                domain="[('project_id.user_id', '=', uid)]" />
        <separator/>
        <filter string="Archived" name="inactive" domain="[('active', '=', False)]"/>
        <separator/>
        <filter name="future" string="Future"
                domain="[('end_datetime', '>=', time.strftime('%%Y-%%m-%%d 00:00:00'))]" />
        <filter name="past" string="Past"
                domain="[('start_datetime', '&lt;=', time.strftime('%%Y-%%m-%%d 22:59:59'))]" />
        <group string="Group By">
          <filter name="group_by_employee_id" string="Employee"
                  context="{'group_by': 'employee_id'}"/>
          <filter name="group_by_project_id" string="Project"
                  context="{'group_by': 'project_id'}"/>
          <filter name="group_by_task_id" string="Task"
                  context="{'group_by': 'task_id'}"/>
        </group>
      </search>
    </field>
  </record>

  <!-- Gantt view -->
  <record id="project_forecast_view_gantt" model="ir.ui.view">
    <field name="name">project.forecast.gantt</field>
    <field name="model">project.forecast</field>
    <field name="arch" type="xml">
      <gantt
             plan="false"
             js_class="forecast_gantt"
             date_start="start_datetime"
             date_stop="end_datetime"
             consolidation="resource_time"
             consolidation_max='{"employee_id": 100}'
             color="color"
             default_scale="week"
             scales="day,week,month"
             precision="{'day': 'hour:full', 'week': 'day:full', 'month': 'day:full'}"
             on_create="%(project_forecast_create_wizard_action)d"
             decoration-warning="published == False"
             decoration-danger="resource_time > 100"
             display_unavailability="1"
      >
        <templates>
            <div t-name="gantt-popover" class="container-fluid">
                <div class="row no-gutters">
                    <div class="col">
                        <ul class="pl-1 mb-0">
                            <t t-if="resource_time > 100">
                                <li><strong class="text-danger">There are more hours planned than available</strong></li>
                            </t>
                            <t t-if="published"></t>
                            <t t-else="">
                                <li><strong class="text-warning">There are non published changes</strong></li>
                            </t>
                            <li><strong>Start Date: </strong> <t t-esc="userTimezoneStartDate.format('YYYY-MM-DD hh:mm:ss A')"/></li>
                            <li><strong>Stop Date: </strong> <t t-esc="userTimezoneStopDate.format('YYYY-MM-DD hh:mm:ss A')"/></li>
                            <li><strong>Planned Hours: </strong> <t t-esc="'' + Math.floor(resource_hours) + ':' + ((resource_hours % 1) * 60 >= 10 ? (resource_hours % 1) * 60 : '0'+(resource_hours % 1) * 60)"/></li>
                            <li><strong>Allocated Time: </strong> <t t-esc="resource_time"/>%</li>
                        </ul>
                    </div>
                </div>
            </div>
        </templates>
        <field name="published" />
        <field name="resource_time" />
        <field name="resource_hours" />
        <field name="recurrency_id" />
      </gantt>
    </field>
  </record>

  <record id="project_forecast_view_pivot" model="ir.ui.view">
    <field name="name">project.forecast.pivot</field>
    <field name="model">project.forecast</field>
    <field name="arch" type="xml">
      <pivot string="Forecast Analysis">
        <field name="resource_time" type="measure"/>
        <field name="start_datetime" interval="week" type="col"/>
      </pivot>
    </field>
  </record>

    <record id="project_forecast_view_graph" model="ir.ui.view">
        <field name="name">project.forecast.graph</field>
        <field name="model">project.forecast</field>
        <field name="arch" type="xml">
            <graph string="Forecast Analysis" type="bar">
                <field name="project_id" type="row"/>
                <field name="employee_id" type="col"/>
                <field name="resource_time" type="measure"/>
             </graph>
         </field>
    </record>

    <!-- Grid views -->
    <record id="project_forecast_view_grid_by_task" model="ir.ui.view">
        <field name="name">project.forecast.grid.by.task</field>
        <field name="model">project.forecast</field>
        <field name="arch" type="xml">
            <grid string="Forecast by task" adjustment="object" adjust_name="adjust_grid">
                <field name="task_id" type="row" section="1"/>
                <field name="employee_id" type="row"/>
                <field name="start_datetime" type="col">
                    <range name="days" string="Day" span="month" step="day" />
                    <range name="weeks" string="Week" span="month" step="week" />
                    <range name="months" string="Month" span="year" step="month" />
                </field>
                <field name="resource_hours" type="measure"/>
            </grid>
        </field>
    </record>

    <record id="view_project_forecast_grid_by_user" model="ir.ui.view">
        <field name="name">project.forecast.grid.by.employee</field>
        <field name="model">project.forecast</field>
        <field name="arch" type="xml">
            <grid string="Forecast by employee" adjustment="object" adjust_name="adjust_grid">
                <field name="employee_id" type="row" section="1"/>
                <field name="project_id" type="row"/>
                <field name="task_id" type="row"/>
                <field name="start_datetime" type="col">
                    <range name="days" string="Day" span="month" step="day" />
                    <range name="weeks" string="Week" span="month" step="week" />
                    <range name="months" string="Month" span="year" step="month" />
                </field>
                <field name="resource_hours" type="measure"/>
            </grid>
        </field>
    </record>

    <record id="view_project_forecast_grid_by_project" model="ir.ui.view">
        <field name="name">project.forecast.grid.by.project</field>
        <field name="model">project.forecast</field>
        <field name="arch" type="xml">
            <grid string="Forecast by project" adjustment="object" adjust_name="adjust_grid">
                <field name="project_id" type="row" section="1"/>
                <field name="task_id" type="row"/>
                <field name="employee_id" type="row"/>
                <field name="start_datetime" type="col">
                    <range name="days" string="Day" span="month" step="day" />
                    <range name="weeks" string="Week" span="month" step="week" />
                    <range name="months" string="Month" span="year" step="month" />
                </field>
                <field name="resource_hours" type="measure"/>
            </grid>
        </field>
    </record>

    <!-- Menus and actions -->
    <menuitem id="project_forecast_menu"
        name="Forecast"
        parent="project.menu_main_pm"
        sequence="2"/>

    <record id="project_forecast_action_by_user" model="ir.actions.act_window">
        <field name="name">Forecast by employee</field>
        <field name="res_model">project.forecast</field>
        <field name="view_mode">gantt,grid,tree,form</field>
        <field name="context">{
            'group_by': ['employee_id'],
        }</field>
    </record>

    <record id="project_forecast_action_view_by_user_gantt" model="ir.actions.act_window.view">
        <field name="view_mode">gantt</field>
        <field name="sequence" eval="1"/>
        <field name="view_id" ref="project_forecast_view_gantt"/>
        <field name="act_window_id" ref="project_forecast_action_by_user"/>
    </record>

    <record id="project_forecast_action_view_by_user_grid" model="ir.actions.act_window.view">
        <field name="view_mode">grid</field>
        <field name="sequence" eval="2"/>
        <field name="view_id" ref="view_project_forecast_grid_by_user"/>
        <field name="act_window_id" ref="project_forecast_action_by_user"/>
    </record>

    <record id="project_forecast_action_by_project" model="ir.actions.act_window">
        <field name="name">Forecast by project</field>
        <field name="res_model">project.forecast</field>
        <field name="view_mode">gantt,grid,tree,form</field>
        <field name="context">{
            'group_by': ['project_id',],
        }</field>
    </record>

    <record id="project_forecast_action_view_by_project_gantt" model="ir.actions.act_window.view">
        <field name="view_mode">gantt</field>
        <field name="sequence" eval="1"/>
        <field name="view_id" ref="project_forecast_view_gantt"/>
        <field name="act_window_id" ref="project_forecast_action_by_project"/>
    </record>

    <record id="project_forecast_action_view_by_project_grid" model="ir.actions.act_window.view">
        <field name="view_mode">grid</field>
        <field name="sequence" eval="2"/>
        <field name="view_id" ref="view_project_forecast_grid_by_project"/>
        <field name="act_window_id" ref="project_forecast_action_by_project"/>
    </record>

    <menuitem id="project_forecast_menu" name="Forecast"
        parent="project.menu_main_pm"
        sequence="2"/>

    <menuitem id="project_forecast_group_by_user"
        name="By Employee"
        parent="project_forecast.project_forecast_menu"
        sequence="10"
        action="project_forecast_action_by_user"/>

    <menuitem id="project_forecast_group_by_project"
        name="By Project"
        parent="project_forecast.project_forecast_menu"
        sequence="20"
        action="project_forecast_action_by_project"/>

    <record id="project_forecast_action_report_activities" model="ir.actions.act_window">
        <field name="name">Forecast Analysis</field>
        <field name="res_model">project.forecast</field>
        <field name="view_mode">pivot,graph,gantt,tree,form</field>
        <field name="context">{'group_by': ['employee_id'],}</field>
    </record>

    <menuitem id="project_forecast_report_activities"
        name="Forecast Analysis"
        parent="project.menu_project_report"
        action="project_forecast_action_report_activities"/>

    <!-- Actions from project kanban -->
    <record id="project_forecast_action_from_project" model="ir.actions.act_window">
        <field name="name">Forecast</field>
        <field name="res_model">project.forecast</field>
        <field name="view_mode">gantt,tree,form,pivot</field>
        <field name="context">{'group_by': ['user_id'],
            'default_project_id': active_id,
            'search_default_project_id': [active_id],
            'search_default_group_by_user_id': 1,
            'project_task_display_forecast': 1,
        }</field>
    </record>

</data>
</odoo>
